---
- name: Ensure base deploy directory exists
  ansible.builtin.file:
    path: "{{ base_deploy_path }}"
    state: directory
    mode: "0755"

- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true
  when: common_upgrade | bool

- name: Upgrade apt packages
  ansible.builtin.apt:
    upgrade: dist
  when: common_upgrade | bool

- name: Install common packages
  ansible.builtin.apt:
    name: "{{ common_packages }}"
    state: present

- name: Ensure docker compose plugin is installed
  ansible.builtin.apt:
    name:
      - docker-compose-plugin
      - python3-docker
    state: present

- name: Check if Python environment is externally managed
  ansible.builtin.stat:
    path: /usr/lib/python3/dist-packages/EXTERNALLY-MANAGED
  register: python_externally_managed

- name: Ensure community.docker collection dependencies are present
  ansible.builtin.pip:
    requirements: "{{ python_virtualenv_root }}/{{ community_docker_requirements_filename }}"
    virtualenv: "{{ python_virtualenv_root }}/{{ community_docker_venv_name }}"
    virtualenv_command: python3 -m venv
    state: present
    extra_args: >-
      {{ '--upgrade --break-system-packages'
         if python_externally_managed.stat.exists | default(false)
         else '--upgrade' }}

- name: Cache community.docker Python interpreter path
  ansible.builtin.set_fact:
    community_docker_python_interpreter: "{{ python_virtualenv_root }}/{{ community_docker_venv_name }}/bin/python"
    docker_python_interpreter: "{{ python_virtualenv_root }}/{{ community_docker_venv_name }}/bin/python"
    cacheable: true

