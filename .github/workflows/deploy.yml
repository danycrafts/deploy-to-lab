name: Manage Home Lab Services

on:
  workflow_dispatch:
    inputs:
      action:
        description: "Operation to perform"
        required: true
        default: install
        type: choice
        options:
          - install
          - update
          - uninstall
      target:
        description: "Remote target in user@host format"
        required: true
        type: string
      ssh_port:
        description: "SSH port for the remote host"
        required: false
        default: '22'
        type: string
      compose_command:
        description: "Docker compose command available on the remote host"
        required: false
        default: "docker compose"
        type: string
      services:
        description: "Whitespace-separated list of services to manage (leave blank for all)"
        required: false
        default: ""
        type: string

concurrency:
  group: manage-home-lab-services
  cancel-in-progress: false

jobs:
  manage:
    name: ${{ inputs.action }} services
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      TARGET: ${{ inputs.target }}
      SSH_PORT: ${{ inputs.ssh_port }}
      COMPOSE_COMMAND: ${{ inputs.compose_command }}
      SERVICES: ${{ inputs.services }}
      ACTION: ${{ inputs.action }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ensure SSH private key is available
        env:
          SSH_PRIVATE_KEY_HOME_LAB: ${{ secrets.SSH_PRIVATE_KEY_HOME_LAB }}
        run: |
          if [ -z "${SSH_PRIVATE_KEY_HOME_LAB:-}" ]; then
            echo "::error::Missing required secret SSH_PRIVATE_KEY_HOME_LAB" >&2
            exit 1
          fi

      - name: Prepare SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY_HOME_LAB }}

      - name: Populate known hosts
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          host="${TARGET##*@}"
          if [ -z "$host" ]; then
            echo "::error::Unable to determine host from target '$TARGET'" >&2
            exit 1
          fi
          ssh-keyscan -p "$SSH_PORT" -H "$host" >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: Run management script
        run: |
          set -euo pipefail

          if [ -z "${TARGET:-}" ]; then
            echo "::error::Target is required" >&2
            exit 1
          fi

          case "$ACTION" in
            install)
              script="install.sh"
              ;;
            update)
              script="configure.sh"
              ;;
            uninstall)
              script="uninstall.sh"
              ;;
            *)
              echo "::error::Unsupported action: $ACTION" >&2
              exit 1
              ;;
          esac

          args=("./scripts/$script")

          if [ -n "${SSH_PORT:-}" ]; then
            args+=("--port" "$SSH_PORT")
          fi

          if [ -n "${COMPOSE_COMMAND:-}" ]; then
            args+=("--compose-cmd" "$COMPOSE_COMMAND")
          fi

          read -r -a service_array <<<"${SERVICES:-}"

          if [ "${#service_array[@]}" -gt 0 ]; then
            args+=("$TARGET" "${service_array[@]}")
          else
            args+=("$TARGET")
          fi

          echo "Running: ${args[*]}"
          "${args[@]}"
